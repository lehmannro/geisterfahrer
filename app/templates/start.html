<!DOCTYPE HTML>
<html>
<head>
   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Start</title>
</head>
<body>
  <a href="javascript:doit();">do it!</a>
  <br/>
<script type="text/javascript" charset="utf-8">

$(document).ready(function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(checkIncident, err);
    }
    else {
        document.write("No navigator.location!");
    }
}); 

function checkIncident(position) {
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;

    var client = new XMLHttpRequest();
    client.open("POST", "/check");
    client.send("lat="+lat+"&lon="+lon+"&timestamp="+new Date(millis(position.timestamp) / 1000).toISOString());
    client.onreadystatechange = warn;
}

function warn(){
    if(this.readyState == this.DONE){
        if(this.responseText){
            alert('Achtung:' + this.responseText);
        }
    }
}

if (navigator.userAgent.match(/iPhone/i)) {
  function millis(domTimeStamp) {
    return domTimeStamp / 1000;
  };
}
else {
  function millis(domTimeStamp) {
    return domTimeStamp;
  };
}


function cb(position) {
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;

    var client = new XMLHttpRequest();
    client.open("POST", "/new");
    client.send("lat="+lat+"&lon="+lon+"&timestamp="+new Date(millis(position.timestamp) / 1000).toISOString());
    //client.send("lat="+lat+"&lon="+lon+"&timestamp="+position.timestamp.toJSON());
    client.onreadystatechange = cb2;
}

function cb2() 
{
    //alert(this.responseXML);
    if(this.readyState == this.DONE){
        alert('your street: ' + this.responseText);
    }
}

function err(e) {
    document.write("Failed. :(<br/>");
    document.write("<br/><b>code:</b> " + e.code);
    document.write("<br/><b>message:</b> " + e.message);
    document.write("<hr>");
}

function doit() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(cb, err);
    }
    else {
        document.write("No navigator.location!");
    }
}

</script>
</body>
</html>

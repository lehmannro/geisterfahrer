<!DOCTYPE HTML>
<html>
<head>
   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Start</title>
    
    <style type="text/css">
        #panicButton{
            background-color: yellow;
            background: -webkit-gradient(linear, left top, left bottom, from(#FFF1A3), to(#FFDC17));
            background: -moz-linear-gradient(top, #FFF1A3, #FFDC17);
            font-family: "Arial", sans-serif;
            font-size:8em;
            font-weight:bold;
            color: #444444;
            line-height: 1;
            text-decoration: none;
            text-align:center;
            display:block;
            border-radius:10px;
            margin: 27px 20px;
            box-shadow: inset 0 1px 10px 1px #ddd, 0 1px 0 #000, 0 6px 0 #444, 0 8px 4px 1px #444;
            top: -7px;
            position: relative;
        }
        #panicButton:active {
            box-shadow: inset 0 1px 10px 1px #bbb, 0 1px 0 #000, 0 2px 0 #444, 0 4px 3px 0px #444;
            position: relative;
            top: -2px;
}
        #warning {
            display: none;
        }
    </style>

</head>
<body>
  <a id="panicButton" href="javascript:doit();">Geisterfahrer!</a>
  <div id="warning"></div>
<script type="text/javascript" charset="utf-8">
    
function lookup(){
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(checkIncident, err);
    }
    else {
        document.write("No navigator.location!");
    }
}

REFRESH_DEFAULT = 300000;
REFRESH_HURRY = 20000;

refreshTimeout = REFRESH_DEFAULT;


$(document).ready(lookup);

function checkIncident(position) {
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;

    var client = new XMLHttpRequest();
    client.open("POST", "/check");
    client.send("lat="+lat+"&lon="+lon+"&timestamp="+new Date(millis(position.timestamp)).toISOString());
    client.onreadystatechange = warn;
}

function warn(){
    if(this.readyState == this.DONE){
        if(this.responseText){
          refreshTimeout = REFRESH_HURRY;
          if (this.responseText != "warning") {
            $("#warning").text(this.responseText).slideDown();
            $("body").css("border", "15px solid red")
            // $("#audio1")[0].play();
          }
        }
        else {
          refreshTimeout = REFRESH_DEFAULT;
        }
        window.setTimeout(lookup, refreshTimeout);
    }
}

if (navigator.userAgent.match(/iPhone/i)) {
  function millis(domTimeStamp) {
    return domTimeStamp / 1000 / 1000;
  };
}
else {
  function millis(domTimeStamp) {
    return domTimeStamp;
  };
}


function cb(position) {
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;

    var client = new XMLHttpRequest();
    client.open("POST", "/new");
    client.send("lat="+lat+"&lon="+lon+"&timestamp="+new Date(millis(position.timestamp)).toISOString());
    //client.send("lat="+lat+"&lon="+lon+"&timestamp="+position.timestamp.toJSON());
    client.onreadystatechange = cb2;
}

function cb2() 
{
    if(this.readyState == this.DONE){
        $("#panicButton").css("background-color", "lightgrey");
    }
}

function err(e) {
    document.write("Failed. :(<br/>");
    document.write("<br/><b>code:</b> " + e.code);
    document.write("<br/><b>message:</b> " + e.message);
    document.write("<hr>");
}

function doit() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(cb, err);
    }
    else {
        document.write("No navigator.location!");
    }
}
</script>

<audio id="audio1" preload="auto">
    <source src="{{ STATIC_URL }}/sounds/alarm.ogg" type="audio/ogg">
</audio>

</body>
</html>
